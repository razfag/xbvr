<template>
  <div>
    <div class="columns">
      <div class="column is-two-thirds">
        <div v-if="items.length > 0">
          <b-table :data="items"
                   ref="table" default-sort="is_available" default-sort-direction="desc">
            <template slot-scope="props">
              <b-table-column field="path" label="Path" sortable>
                {{props.row.path}}
              </b-table-column>
              <b-table-column field="is_available" label="Available" sortable>
                <b-icon pack="fas" icon="check" size="is-small" v-if="props.row.is_available"></b-icon>
              </b-table-column>
              <b-table-column field="file_count" label="# of files" sortable>
                {{props.row.file_count}}
              </b-table-column>
              <b-table-column field="unmatched_count" label="Not matched" sortable>
                {{props.row.unmatched_count}}
              </b-table-column>
              <b-table-column field="total_size" label="Total size" sortable>
                {{prettyBytes(props.row.total_size)}}
              </b-table-column>
              <b-table-column field="last_scan" label="Last scan" sortable>
                {{distanceInWordsToNow(parse(props.row.last_scan))}} ago
              </b-table-column>
              <b-table-column field="is_available" label="Action" sortable>
                <a :class="{ 'button': true, 'is-button': true, 'is-danger': props.row.file_count !== props.row.unmatched_count, 'is-warning': props.row.file_count === props.row.unmatched_count}"
                   v-on:click="removeFolder(props)">
                  <b-icon pack="fas" icon="trash"></b-icon>
                </a>
              </b-table-column>
            </template>
            <template slot="footer">
              <td></td>
              <td></td>
              <td>{{total.files}}</td>
              <td>{{total.unmatched}}</td>
              <td>{{prettyBytes(total.size)}}</td>
              <td></td>
            </template>
          </b-table>

          <div class="button is-button is-primary" v-on:click="taskRescan">Rescan</div>
        </div>
      </div>

      <div class="column">
        <div class="field">
          <label class="label">Path to folder with content</label>
          <div class="control">
            <input class="input" type="text" v-model='newVolumePath'>
          </div>
        </div>
        <div class="control">
          <button class="button is-link" v-on:click='addFolder'>Add new folder</button>
        </div>
      </div>
    </div>

    <div class="columns">
      <div class="column is-full">
        <b-message v-if="Object.keys(lastMessage).length !== 0">
          <span class="icon" v-if="lock">
            <i class="fas fa-spinner fa-pulse"></i>
          </span>
          {{lastMessage.message}}
        </b-message>
      </div>
    </div>
  </div>
</template>

<script>
  import ky from "ky";
  import prettyBytes from "pretty-bytes";
  import {distanceInWordsToNow, parse} from "date-fns";

  export default {
    name: "OptionsFolders",
    data() {
      return {
        volumes: [],
        newVolumePath: "",
        prettyBytes,
        parse,
        distanceInWordsToNow,
      }
    },
    mounted() {
      this.$store.dispatch("optionsFolders/load");
    },
    methods: {
      taskRescan: function () {
        ky.get(`/api/task/rescan`);
      },
      addFolder: async function () {
        await ky.post(`/api/config/volume`, {json: {path: this.newVolumePath}}).json();
        this.$store.dispatch("optionsFolders/load");
      },
      removeFolder: async function (folder) {
        // TODO: add confirmation
        await ky.delete(`/api/config/volume/${folder.row.id}`).json();
        // TODO: hook folder load into async callback
        this.$store.dispatch("optionsFolders/load");
      }
    },
    computed: {
      total() {
        let files = 0, unmatched = 0, size = 0;
        this.$store.state.optionsFolders.items.map(v => {
          files = files + v.file_count;
          unmatched = unmatched + v.unmatched_count;
          size = size + v.total_size;
        });
        return {files, unmatched, size}
      },
      items() {
        return this.$store.state.optionsFolders.items;
      },
      lastMessage() {
        return this.$store.state.messages.lastRescanMessage;
      },
      lock() {
        return this.$store.state.messages.lockRescan;
      }
    }
  }
</script>
